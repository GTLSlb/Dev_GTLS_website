name: New Laravel Deployment

on:
  push:
    branches:
      - main  # Change this to the branch you want to deploy

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1'  # Adjust the PHP version as needed

    - name: Install Composer dependencies
      run: composer install --no-interaction --prefer-dist

    - name: Set up environment file
      run: cp .env.example .env

    - name: Generate application key
      run: php artisan key:generate

    - name: Run database migrations and seed
      run: php artisan migrate --seed

    - name: Install Node.js and npm
      uses: actions/setup-node@v2
      with:
        node-version: '18.3.0'  # Adjust the Node.js version as needed

    - name: Install npm dependencies
      run: npm install

    - name: Build assets
      run: npm run production

    - name: Deploy to server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        password: ${{ secrets.SERVER_PASSWORD }}
        script: |
          cd /path/to/your/laravel/project
          git pull origin main  # Change this to your branch
          composer install --no-interaction --prefer-dist
          php artisan migrate --force
          php artisan config:cache
          php artisan route:cache
          php artisan optimize
          php artisan view:cache
